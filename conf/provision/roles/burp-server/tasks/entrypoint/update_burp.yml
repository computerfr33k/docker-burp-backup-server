---

- debug: msg="updating burp installation..."

# Clean existing git repo
- file: path=/tmp/burp state=absent

- name: Download Lastest Source Code
  git:
    repo: https://github.com/grke/burp.git
    dest: /tmp/burp
    version: "{{ remote_version.stdout }}"
    accept_hostkey: yes
  when: VERSION == "latest"

# Install version based on env when not set to latest
- name: Download Specified Version
  git:
    repo: https://github.com/grke/burp.git
    dest: /tmp/burp
    version: "{{ VERSION }}"
    accept_hostkey: yes
  when: VERSION != "latest"

- name: Generate automake files
  command: autoreconf -vif
  args:
    chdir: /tmp/burp

- name: Configure build options
  command: ./configure --prefix=/usr --sysconfdir=/etc/burp --localstatedir=/data
  args:
    chdir: /tmp/burp

# Build the default target
- name: Build Burp
  make:
    chdir: /tmp/burp

# Run `install` target
- name: Install Burp
  make:
    chdir: /tmp/burp
    target: install

- stat: path=/etc/burp/burp-server.conf
  register: install_configs

- name: Install Configs
  make:
    chdir: /tmp/burp
    target: install-configs
  when: install_configs.stat.exists == False

- name: Save installed version info
  copy:
    content: "{{ remote_version.stdout }}"
    dest: /.installed_version.txt